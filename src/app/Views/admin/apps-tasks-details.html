<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Historia Clínica Odontológica | Sistema Dental</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- App favicon -->
    <link rel="shortcut icon" href="assets/admin/assets/images/favicon.ico">
    
    <!-- Vendor css -->
    <link href="assets/admin/assets/css/vendor.min.css" rel="stylesheet" type="text/css" />
    
    <!-- App css -->
    <link href="assets/admin/assets/css/app.min.css" rel="stylesheet" type="text/css" id="app-style" />
    
    <!-- Icons css -->
    <link href="assets/admin/assets/css/unicons/css/unicons.css" rel="stylesheet" type="text/css" />
    
    <style>
        .section-title {
            background-color: #f1f3fa;
            padding: 10px 15px;
            margin: 20px 0 15px 0;
            border-left: 4px solid #6c5ce7;
            font-weight: 600;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .checkbox-item {
            flex: 0 0 calc(33.333% - 10px);
        }
        .odontogram-container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .tooth-diagram {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        .tooth-item {
            border: 2px solid #ddd;
            padding: 8px 4px;
            text-align: center;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tooth-item:hover {
            background-color: #f0f0f0;
            border-color: #6c5ce7;
        }
        .tooth-item.selected {
            background-color: #6c5ce7;
            color: white;
            border-color: #6c5ce7;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- Navbar y Sidebar -->
        <?php include 'includes/navbar.php'; ?>
        <?php include 'includes/sidebar.php'; ?>

        <div class="content-page">
            <div class="content">
                <div class="container-fluid">
                    
                    <!-- Page Title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box">
                                <div class="page-title-right">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item"><a href="/admin">Home</a></li>
                                        <li class="breadcrumb-item"><a href="patients">Pacientes</a></li>
                                        <li class="breadcrumb-item active">Historia Clínica Odontológica</li>
                                    </ol>
                                </div>
                                <h4 class="page-title">Historia Clínica Odontológica</h4>
                            </div>
                        </div>
                    </div>

                    <form action="add-dental-history" method="POST" id="dentalHistoryForm">
                        
                        <!-- SECCIÓN 1: IDENTIFICACIÓN DEL PACIENTE -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="section-title">1. IDENTIFICACIÓN DEL PACIENTE</h4>
                                        
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Seleccionar Paciente Existente</label>
                                                <select class="form-control" id="patient_id" name="patient_id" required>
                                                    <option value="">-- Seleccionar --</option>
                                                    <?php 
                                                    // Aquí irá el código PHP para cargar pacientes
                                                    ?>
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Nº Historia Clínica</label>
                                                <input type="text" class="form-control" name="history_number" required>
                                            </div>
                                            
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Fecha de Registro</label>
                                                <input type="date" class="form-control" name="registration_date" value="<?php echo date('Y-m-d'); ?>" required>
                                            </div>
                                            
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Documento de Identidad</label>
                                                <input type="text" class="form-control" name="identification_document" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Nombres y Apellidos</label>
                                                <input type="text" class="form-control" name="patient_fullname" id="patient_fullname" readonly>
                                            </div>
                                            
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Fecha de Nacimiento</label>
                                                <input type="date" class="form-control" name="birth_date" id="birth_date" readonly>
                                            </div>
                                            
                                            <div class="col-md-2 mb-3">
                                                <label class="form-label">Edad</label>
                                                <input type="text" class="form-control" name="age" id="age" readonly>
                                            </div>
                                            
                                            <div class="col-md-2 mb-3">
                                                <label class="form-label">Género</label>
                                                <input type="text" class="form-control" name="gender" id="gender" readonly>
                                            </div>
                                            
                                            <div class="col-md-2 mb-3">
                                                <label class="form-label">Teléfono</label>
                                                <input type="text" class="form-control" name="phone" id="phone" readonly>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Dirección Residencial</label>
                                                <textarea class="form-control" name="residential_address" rows="2"></textarea>
                                            </div>
                                            
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Nombre del Responsable</label>
                                                <input type="text" class="form-control" name="responsible_name">
                                            </div>
                                            
                                            <div class="col-md-3 mb-3">
                                                <label class="form-label">Teléfono del Responsable</label>
                                                <input type="text" class="form-control" name="responsible_phone">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN 2: MOTIVO DE CONSULTA -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="section-title">2. MOTIVO DE CONSULTA</h4>
                                        <div class="mb-3">
                                            <textarea class="form-control" name="reason_consultation" rows="3" placeholder="Describa el motivo de la consulta..."></textarea>
                                        </div>
                                        
                                        <h5 class="mt-3">Enfermedad Actual</h5>
                                        <div class="mb-3">
                                            <textarea class="form-control" name="current_illness" rows="3" placeholder="Describa la enfermedad actual..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN 3: ANTECEDENTES MÉDICOS Y FAMILIARES -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="section-title">3. ANTECEDENTES MÉDICOS Y FAMILIARES</h4>
                                        
                                        <div class="checkbox-group">
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="cardiovascular" id="cardiovascular">
                                                    <label class="form-check-label" for="cardiovascular">
                                                        Cardiovascular
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="hemophilia" id="hemophilia">
                                                    <label class="form-check-label" for="hemophilia">
                                                        Hemofilia
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="allergies" id="allergies">
                                                    <label class="form-check-label" for="allergies">
                                                        Alergias
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="hypertension" id="hypertension">
                                                    <label class="form-check-label" for="hypertension">
                                                        Hipertensión
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="anemia" id="anemia">
                                                    <label class="form-check-label" for="anemia">
                                                        Anemia
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="respiratory_disease" id="respiratory_disease">
                                                    <label class="form-check-label" for="respiratory_disease">
                                                        Enf. Respiratorias
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="diabetes" id="diabetes">
                                                    <label class="form-check-label" for="diabetes">
                                                        Diabetes
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="hepatitis" id="hepatitis">
                                                    <label class="form-check-label" for="hepatitis">
                                                        Hepatitis
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="hospitalization" id="hospitalization">
                                                    <label class="form-check-label" for="hospitalization">
                                                        Hospitalización
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="osteoporosis" id="osteoporosis">
                                                    <label class="form-check-label" for="osteoporosis">
                                                        Osteoporosis
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="chemotherapy" id="chemotherapy">
                                                    <label class="form-check-label" for="chemotherapy">
                                                        Quimioterapia
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="hiv" id="hiv">
                                                    <label class="form-check-label" for="hiv">
                                                        VIH
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Detalle de Alergias</label>
                                                <textarea class="form-control" name="allergy_detail" rows="2" placeholder="Especificar alergias..."></textarea>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Otras Enfermedades</label>
                                                <textarea class="form-control" name="other_diseases" rows="2" placeholder="Otras enfermedades o condiciones..."></textarea>
                                            </div>
                                        </div>
                                        
                                        <h5 class="mt-3">3.1 Antecedentes Familiares</h5>
                                        <div class="mb-3">
                                            <textarea class="form-control" name="family_background" rows="3" placeholder="Describa antecedentes médicos familiares relevantes..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN 4: ODONTOGRAMA -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="section-title">4. ODONTOGRAMA</h4>
                                        
                                        <div class="odontogram-container">
                                            <p class="text-muted mb-2">Seleccione los dientes para registrar su estado</p>
                                            
                                            <!-- Dientes Superiores -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Arcada Superior</label>
                                                <div class="tooth-diagram" id="upperTeeth">
                                                    <!-- Cuadrante Superior Derecho (18-11) -->
                                                    <div class="tooth-item" data-tooth="18">18</div>
                                                    <div class="tooth-item" data-tooth="17">17</div>
                                                    <div class="tooth-item" data-tooth="16">16</div>
                                                    <div class="tooth-item" data-tooth="15">15</div>
                                                    <div class="tooth-item" data-tooth="14">14</div>
                                                    <div class="tooth-item" data-tooth="13">13</div>
                                                    <div class="tooth-item" data-tooth="12">12</div>
                                                    <div class="tooth-item" data-tooth="11">11</div>
                                                    <!-- Cuadrante Superior Izquierdo (21-28) -->
                                                    <div class="tooth-item" data-tooth="21">21</div>
                                                    <div class="tooth-item" data-tooth="22">22</div>
                                                    <div class="tooth-item" data-tooth="23">23</div>
                                                    <div class="tooth-item" data-tooth="24">24</div>
                                                    <div class="tooth-item" data-tooth="25">25</div>
                                                    <div class="tooth-item" data-tooth="26">26</div>
                                                    <div class="tooth-item" data-tooth="27">27</div>
                                                    <div class="tooth-item" data-tooth="28">28</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Dientes Inferiores -->
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Arcada Inferior</label>
                                                <div class="tooth-diagram" id="lowerTeeth">
                                                    <!-- Cuadrante Inferior Derecho (48-41) -->
                                                    <div class="tooth-item" data-tooth="48">48</div>
                                                    <div class="tooth-item" data-tooth="47">47</div>
                                                    <div class="tooth-item" data-tooth="46">46</div>
                                                    <div class="tooth-item" data-tooth="45">45</div>
                                                    <div class="tooth-item" data-tooth="44">44</div>
                                                    <div class="tooth-item" data-tooth="43">43</div>
                                                    <div class="tooth-item" data-tooth="42">42</div>
                                                    <div class="tooth-item" data-tooth="41">41</div>
                                                    <!-- Cuadrante Inferior Izquierdo (31-38) -->
                                                    <div class="tooth-item" data-tooth="31">31</div>
                                                    <div class="tooth-item" data-tooth="32">32</div>
                                                    <div class="tooth-item" data-tooth="33">33</div>
                                                    <div class="tooth-item" data-tooth="34">34</div>
                                                    <div class="tooth-item" data-tooth="35">35</div>
                                                    <div class="tooth-item" data-tooth="36">36</div>
                                                    <div class="tooth-item" data-tooth="37">37</div>
                                                    <div class="tooth-item" data-tooth="38">38</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Registro de estado por diente -->
                                            <div id="toothDetailsContainer"></div>
                                        </div>
                                        
                                        <h5 class="mt-4">4.1 Estado Periodontal</h5>
                                        <div class="mb-3">
                                            <textarea class="form-control" name="periodontal_status" rows="3" placeholder="Describa el estado periodontal general..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN 5: ANTECEDENTES ODONTOLÓGICOS -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="section-title">5. ANTECEDENTES ODONTOLÓGICOS</h4>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Tratamientos Previos</label>
                                                <textarea class="form-control" name="previous_treatments" rows="3"></textarea>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Fecha de Última Visita Dental</label>
                                                <input type="date" class="form-control" name="last_visit_date">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="dental_trauma" id="dental_trauma">
                                                    <label class="form-check-label" for="dental_trauma">
                                                        ¿Ha tenido trauma dental?
                                                    </label>
                                                </div>
                                                <textarea class="form-control mt-2" name="trauma_detail" rows="2" placeholder="Detalle del trauma..."></textarea>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="orthodontic_treatment" id="orthodontic_treatment">
                                                    <label class="form-check-label" for="orthodontic_treatment">
                                                        ¿Ha tenido tratamiento de ortodoncia?
                                                    </label>
                                                </div>
                                                <textarea class="form-control mt-2" name="orthodontic_detail" rows="2" placeholder="Detalle del tratamiento..."></textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Observaciones Adicionales</label>
                                            <textarea class="form-control" name="dental_observations" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN 6: DIAGNÓSTICO -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="section-title">6. DIAGNÓSTICO ORTODONCIA Y ORTOPEDIA</h4>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Esquelético</label>
                                                <textarea class="form-control" name="skeletal_diagnosis" rows="3" placeholder="Diagnóstico esquelético..."></textarea>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Facial</label>
                                                <textarea class="form-control" name="facial_diagnosis" rows="3" placeholder="Diagnóstico facial..."></textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Dental</label>
                                                <textarea class="form-control" name="dental_diagnosis" rows="3" placeholder="Diagnóstico dental..."></textarea>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Funcional</label>
                                                <textarea class="form-control" name="functional_diagnosis" rows="3" placeholder="Diagnóstico funcional..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN 7: PLAN DE TRATAMIENTO -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="section-title">7. PLAN DE TRATAMIENTO</h4>
                                        
                                        <div id="treatmentPlanContainer">
                                            <div class="treatment-item border p-3 mb-3 rounded">
                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Descripción del Tratamiento</label>
                                                        <input type="text" class="form-control" name="treatment_description[]" placeholder="Ej: Extracción dental">
                                                    </div>
                                                    
                                                    <div class="col-md-2 mb-3">
                                                        <label class="form-label">Diente(s)</label>
                                                        <input type="text" class="form-control" name="tooth_involved[]" placeholder="Ej: 18, 28">
                                                    </div>
                                                    
                                                    <div class="col-md-2 mb-3">
                                                        <label class="form-label">Costo Estimado</label>
                                                        <input type="number" step="0.01" class="form-control" name="estimated_cost[]" placeholder="0.00">
                                                    </div>
                                                    
                                                    <div class="col-md-2 mb-3">
                                                        <label class="form-label">Prioridad</label>
                                                        <select class="form-control" name="priority[]">
                                                            <option value="Alta">Alta</option>
                                                            <option value="Media" selected>Media</option>
                                                            <option value="Baja">Baja</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <div class="col-md-2 mb-3">
                                                        <label class="form-label">Fecha Planeada</label>
                                                        <input type="date" class="form-control" name="planned_date[]">
                                                    </div>
                                                    
                                                    <div class="col-md-12 mb-2">
                                                        <label class="form-label">Observaciones</label>
                                                        <textarea class="form-control" name="treatment_observations[]" rows="2"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <button type="button" class="btn btn-secondary btn-sm" id="addTreatmentBtn">
                                            <i class="uil-plus"></i> Agregar Otro Tratamiento
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BOTONES DE ACCIÓN -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body text-end">
                                        <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                            <i class="uil-arrow-left"></i> Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="uil-save"></i> Guardar Historia Clínica
                                        </button>
                                        <button type="button" class="btn btn-success" id="saveAndPrintBtn">
                                            <i class="uil-print"></i> Guardar y Generar PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>

                </div> <!-- container -->
            </div> <!-- content -->

            <!-- Footer -->
            <?php include 'includes/footer.php'; ?>

        </div>
    </div>

    <!-- Scripts -->
    <script src="assets/admin/assets/js/vendor.min.js"></script>
    <script src="assets/admin/assets/js/app.js"></script>
    
    <script>
        // Datos de dientes seleccionados
        const selectedTeeth = new Set();
        
        // Manejar selección de dientes
        document.querySelectorAll('.tooth-item').forEach(item => {
            item.addEventListener('click', function() {
                const toothNumber = this.getAttribute('data-tooth');
                
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    selectedTeeth.delete(toothNumber);
                    removeToothDetail(toothNumber);
                } else {
                    this.classList.add('selected');
                    selectedTeeth.add(toothNumber);
                    addToothDetail(toothNumber);
                }
            });
        });
        
        // Agregar detalle de diente
        function addToothDetail(toothNumber) {
            const container = document.getElementById('toothDetailsContainer');
            const detailDiv = document.createElement('div');
            detailDiv.className = 'row border-top pt-3 mt-3 tooth-detail';
            detailDiv.id = `tooth-detail-${toothNumber}`;
            detailDiv.innerHTML = `
                <div class="col-md-12 mb-2">
                    <h6>Diente ${toothNumber}</h6>
                </div>
                <input type="hidden" name="tooth_number[]" value="${toothNumber}">
                <div class="col-md-3 mb-2">
                    <label class="form-label">Estado</label>
                    <select class="form-control form-control-sm" name="tooth_status_${toothNumber}">
                        <option value="">Seleccionar</option>
                        <option value="Sano">Sano</option>
                        <option value="Caries">Caries</option>
                        <option value="Obturado">Obturado</option>
                        <option value="Corona">Corona</option>
                        <option value="Ausente">Ausente</option>
                        <option value="Fracturado">Fracturado</option>
                        <option value="Endodoncia">Endodoncia</option>
                        <option value="Implante">Implante</option>
                        <option value="Extracción Indicada">Extracción Indicada</option>
                    </select>
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label">Código de Condición</label>
                    <input type="text" class="form-control form-control-sm" name="condition_code_${toothNumber}" placeholder="Código">
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label">Observaciones</label>
                    <input type="text" class="form-control form-control-sm" name="tooth_observations_${toothNumber}" placeholder="Observaciones del diente">
                </div>
            `;
            container.appendChild(detailDiv);
        }
        
        // Remover detalle de diente
        function removeToothDetail(toothNumber) {
            const detailDiv = document.getElementById(`tooth-detail-${toothNumber}`);
            if (detailDiv) {
                detailDiv.remove();
            }
        }
        
        // Agregar más tratamientos al plan
        document.getElementById('addTreatmentBtn').addEventListener('click', function() {
            const container = document.getElementById('treatmentPlanContainer');
            const newTreatment = document.createElement('div');
            newTreatment.className = 'treatment-item border p-3 mb-3 rounded position-relative';
            newTreatment.innerHTML = `
                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 remove-treatment">
                    <i class="uil-times"></i>
                </button>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Descripción del Tratamiento</label>
                        <input type="text" class="form-control" name="treatment_description[]" placeholder="Ej: Extracción dental">
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Diente(s)</label>
                        <input type="text" class="form-control" name="tooth_involved[]" placeholder="Ej: 18, 28">
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Costo Estimado</label>
                        <input type="number" step="0.01" class="form-control" name="estimated_cost[]" placeholder="0.00">
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Prioridad</label>
                        <select class="form-control" name="priority[]">
                            <option value="Alta">Alta</option>
                            <option value="Media" selected>Media</option>
                            <option value="Baja">Baja</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Fecha Planeada</label>
                        <input type="date" class="form-control" name="planned_date[]">
                    </div>
                    
                    <div class="col-md-12 mb-2">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" name="treatment_observations[]" rows="2"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(newTreatment);
        });
        
        // Remover tratamiento
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-treatment') || e.target.parentElement.classList.contains('remove-treatment')) {
                const treatmentItem = e.target.closest('.treatment-item');
                treatmentItem.remove();
            }
        });
        
        // Cargar datos del paciente seleccionado
        document.getElementById('patient_id').addEventListener('change', function() {
            const patientId = this.value;
            if (patientId) {
                // Aquí iría una llamada AJAX para cargar los datos del paciente
                // Por ahora, mostramos un ejemplo estático
                fetch(`get-patient-data.php?id=${patientId}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('patient_fullname').value = data.name + ' ' + data.lastname;
                        document.getElementById('birth_date').value = data.birth_date;
                        document.getElementById('age').value = calculateAge(data.birth_date);
                        document.getElementById('gender').value = data.gender;
                        document.getElementById('phone').value = data.phone;
                        document.querySelector('[name="identification_document"]').value = data.idnumber;
                    })
                    .catch(error => console.error('Error:', error));
            }
        });
        
        // Calcular edad
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age + ' años';
        }
        
        // Guardar y generar PDF
        document.getElementById('saveAndPrintBtn').addEventListener('click', function() {
            const form = document.getElementById('dentalHistoryForm');
            const formData = new FormData(form);
            formData.append('generate_pdf', '1');
            
            // Validar formulario
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Enviar datos
            fetch('add-dental-history', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Historia clínica guardada exitosamente');
                    // Abrir PDF en nueva ventana
                    window.open(data.pdf_url, '_blank');
                    // Opcional: Redirigir
                    // window.location.href = 'dental-histories';
                } else {
                    alert('Error al guardar: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al procesar la solicitud');
            });
        });
        
        // Validación de formulario antes de enviar
        document.getElementById('dentalHistoryForm').addEventListener('submit', function(e) {
            const patientId = document.getElementById('patient_id').value;
            if (!patientId) {
                e.preventDefault();
                alert('Por favor seleccione un paciente');
                return false;
            }
        });
    </script>

</body>
</html>